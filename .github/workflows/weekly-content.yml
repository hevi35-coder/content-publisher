name: Weekly Content Automation

on:
  schedule:
    # 1. Topic Committee: Sunday at 16:07 KST (Sunday 07:07 UTC)
    - cron: '7 7 * * 0'
    # 2. Draft Writer: Tuesday/Thursday/Saturday at 16:07 KST (Tuesday/Thursday/Saturday 07:07 UTC)
    - cron: '7 7 * * 2,4,6'
  workflow_dispatch: # Allow manual trigger
    inputs:
      run_target:
        description: "Select which step to run"
        required: true
        default: both
        type: choice
        options:
          - both
          - topic
          - draft
      dry_run:
        description: "Simulate workflow without push/PR merge side effects"
        required: true
        default: 'true'
        type: choice
        options:
          - 'false'
          - 'true'
      manual_fallback_force:
        description: "Bypass fallback timing guard (emergency only)"
        required: true
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'
      skip_draft_writer:
        description: "Rehearsal mode: skip draft generation step"
        required: true
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

jobs:
  automation:
    runs-on: ubuntu-latest
    env:
      TZ: Asia/Seoul
    permissions:
      contents: write # Needed to push changes (QUEUE updates, new Drafts)
      pull-requests: write # Needed if we want to make a PR (future)
      statuses: write # Needed to set required status check context on bot-created PR branches
      actions: write # Needed to trigger downstream auto-publish workflow_dispatch

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: npm ci

      - name: Preflight Topic Inputs
        if: github.event.schedule == '7 7 * * 0' || (github.event_name == 'workflow_dispatch' && (github.event.inputs.run_target == 'both' || github.event.inputs.run_target == 'topic'))
        env:
          GITHUB_MODELS_TOKEN: ${{ secrets.MODELS_TOKEN }}
        run: |
          set -euo pipefail
          if [ -z "${GITHUB_MODELS_TOKEN:-}" ]; then
            echo "::error::Missing required secret: MODELS_TOKEN"
            exit 1
          fi
          echo "‚úÖ Topic preflight passed."
          {
            echo "# Weekly Workflow Preflight"
            echo
            echo "- Topic preflight: passed"
            echo "- Trigger: ${{ github.event_name }}"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Run Topic Committee (Sun)
        if: github.event.schedule == '7 7 * * 0' || (github.event_name == 'workflow_dispatch' && (github.event.inputs.run_target == 'both' || github.event.inputs.run_target == 'topic'))
        env:
          GITHUB_MODELS_TOKEN: ${{ secrets.MODELS_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          AUTO_SYNC_QUEUE: 'false'
          DRY_RUN: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.dry_run || 'false' }}
          RUN_TARGET: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.run_target || '' }}
        run: |
          set -euo pipefail

          echo "DRY_RUN=${DRY_RUN}"
          node select_topic.js
          git config --global user.name "MandaAct Bot"
          git config --global user.email "bot@mandaact.com"
          git add TOPIC_QUEUE.md
          if git diff --cached --quiet; then
            echo "No topic queue changes."
            exit 0
          fi

          if [ "${DRY_RUN}" = "true" ]; then
            echo "DRY_RUN enabled: skipping topic push and PR creation."
            exit 0
          fi

          BRANCH_NAME="topic/weekly-$(date +%Y-%m-%d)-${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}"
          git checkout -b "$BRANCH_NAME"
          git commit -m "chore(topic): weekly topic selection"

          echo "üß™ Running regression tests before posting pr-sanity status..."
          npm test

          HEAD_SHA=$(git rev-parse HEAD)
          git push origin "$BRANCH_NAME"

          echo "üöÄ Creating Topic Pull Request..."
          PR_URL=$(gh pr create --title "üß≠ Weekly Topic Queue: $(date +%Y-%m-%d)" --body "Automated topic queue update. **Auto-merge enabled**." --base main --head "$BRANCH_NAME")
          PR_NUMBER=$(gh pr view "$PR_URL" --json number --jq '.number')
          echo "üìù Topic PR Created: $PR_URL"

          echo "‚úÖ Posting required status context (pr-sanity) for Topic PR..."
          gh api "repos/${GITHUB_REPOSITORY}/statuses/${HEAD_SHA}" \
            -f state='success' \
            -f context='pr-sanity' \
            -f description='Sanity passed (npm test) in Weekly Content Automation' \
            -f target_url="https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"

          echo "üîÑ Enabling Topic Auto-Merge..."
          gh pr merge --auto --squash --delete-branch "$PR_NUMBER"

          if [ "${RUN_TARGET}" = "both" ]; then
            echo "‚è≥ Waiting for Topic PR #${PR_NUMBER} merge before Draft Writer..."
            for _ in $(seq 1 30); do
              MERGED_AT=$(gh pr view "${PR_NUMBER}" --json mergedAt --jq '.mergedAt')
              if [ "${MERGED_AT}" != "null" ] && [ -n "${MERGED_AT}" ]; then
                echo "‚úÖ Topic PR merged at ${MERGED_AT}"
                break
              fi
              sleep 2
            done

            MERGED_AT=$(gh pr view "${PR_NUMBER}" --json mergedAt --jq '.mergedAt')
            if [ "${MERGED_AT}" = "null" ] || [ -z "${MERGED_AT}" ]; then
              echo "‚ùå Topic PR merge timeout. Stopping before Draft Writer."
              exit 1
            fi
          fi

          # Keep workspace in sync with remote main for subsequent steps.
          git checkout main
          git pull --ff-only origin main

      - name: Preflight Draft Inputs
        if: github.event.schedule == '7 7 * * 2,4,6' || (github.event_name == 'workflow_dispatch' && (github.event.inputs.run_target == 'both' || github.event.inputs.run_target == 'draft'))
        timeout-minutes: 3
        env:
          GITHUB_MODELS_TOKEN: ${{ secrets.MODELS_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GH_AUTH_MAX_ATTEMPTS: '4'
          GH_AUTH_RETRY_BASE_MS: '2000'
          GH_AUTH_REQUEST_TIMEOUT_SECONDS: '10'
          GH_AUTH_TOTAL_TIMEOUT_SECONDS: '60'
        run: |
          set -euo pipefail
          if [ -z "${GITHUB_MODELS_TOKEN:-}" ]; then
            echo "::error::Missing required secret: MODELS_TOKEN"
            exit 1
          fi
          ./scripts/check-gh-cli-auth.sh
          echo "‚úÖ Draft preflight passed."
          {
            echo "- Draft preflight: passed"
            echo "- GH auth: passed"
            echo "- Trigger: ${{ github.event_name }}"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Enforce Manual Fallback Window
        if: github.event_name == 'workflow_dispatch' && (github.event.inputs.run_target == 'both' || github.event.inputs.run_target == 'draft')
        env:
          EVENT_NAME: ${{ github.event_name }}
          RUN_TARGET: ${{ github.event.inputs.run_target || '' }}
          DRY_RUN: ${{ github.event.inputs.dry_run || 'true' }}
          MANUAL_FALLBACK_FORCE: ${{ github.event.inputs.manual_fallback_force || 'false' }}
          MANUAL_FALLBACK_MIN_DELAY_MINUTES: '60'
          MANUAL_FALLBACK_EARLY_ALLOWANCE_MINUTES: '15'
          MANUAL_FALLBACK_API_MAX_ATTEMPTS: '3'
          MANUAL_FALLBACK_API_RETRY_BASE_MS: '2000'
          WEEKLY_WORKFLOW_REF: '.github/workflows/weekly-content.yml'
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          node scripts/enforce-manual-fallback-window.js

      - name: Run Draft Writer (Tue, Thu, Sat)
        if: (github.event.schedule == '7 7 * * 2,4,6' || (github.event_name == 'workflow_dispatch' && (github.event.inputs.run_target == 'both' || github.event.inputs.run_target == 'draft'))) && !(github.event_name == 'workflow_dispatch' && (github.event.inputs.skip_draft_writer || 'false') == 'true')
        env:
          GITHUB_MODELS_TOKEN: ${{ secrets.MODELS_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SKIP_COVER_MAIN_SYNC: 'true'
          AUTO_PUBLISH_AFTER_DRAFT: 'false'
          DRY_RUN: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.dry_run || 'false' }}
        run: |
          set -euo pipefail

          # Configure Git first (generate_draft may run git sync for assets)
          git config --global user.name "MandaAct Bot"
          git config --global user.email "bot@mandaact.com"

          echo "DRY_RUN=${DRY_RUN}"
          node generate_draft.js

          if [ "${DRY_RUN}" = "true" ]; then
            echo "DRY_RUN enabled: skipping branch push and PR creation."
            exit 0
          fi
          
          # Create unique branch per run to avoid force-push/delete flows.
          BRANCH_NAME="draft/weekly-$(date +%Y-%m-%d)-${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}"
          git checkout -b "$BRANCH_NAME"
          
          # Commit changes
          git add drafts/ TOPIC_QUEUE.md assets/
          if git diff --cached --quiet; then
            echo "No changes generated. Skipping PR creation."
            exit 0
          fi
          DRAFT_FILES_CSV=$(git diff --cached --name-only -- 'drafts/*.md' | paste -sd, -)
          if [ -z "${DRAFT_FILES_CSV}" ]; then
            echo "::warning::No drafts/*.md changes detected in commit set. Auto Publish dispatch will be skipped."
          else
            echo "Draft files for publish: ${DRAFT_FILES_CSV}"
          fi
          git commit -m "chore(content): generate weekly draft"

          echo "üß™ Running regression tests before posting pr-sanity status..."
          npm test

          HEAD_SHA=$(git rev-parse HEAD)
          
          # Push branch (no force; unique branch name prevents conflicts)
          git push origin "$BRANCH_NAME"
          
          # Create Pull Request (Needs GITHUB_TOKEN)
          echo "üöÄ Creating Pull Request..."
          PR_URL=$(gh pr create --title "üìù Weekly Draft: $(date +%Y-%m-%d)" --body "This week's draft is ready. **Auto-merge enabled** - will merge immediately after creation." --base main --head "$BRANCH_NAME")
          echo "üìù PR Created: $PR_URL"

          echo "‚úÖ Posting required status context (pr-sanity) for Draft PR..."
          gh api "repos/${GITHUB_REPOSITORY}/statuses/${HEAD_SHA}" \
            -f state='success' \
            -f context='pr-sanity' \
            -f description='Sanity passed (npm test) in Weekly Content Automation' \
            -f target_url="https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
          
          # Enable Auto-Merge (requires repo setting: Settings > General > Allow auto-merge)
          echo "üîÑ Enabling Auto-Merge..."
          gh pr merge --auto --squash --delete-branch "$PR_URL"

          echo "‚è≥ Waiting for Draft PR merge before triggering Auto Publish..."
          for _ in $(seq 1 60); do
            MERGED_AT=$(gh pr view "${PR_URL}" --json mergedAt --jq '.mergedAt')
            if [ "${MERGED_AT}" != "null" ] && [ -n "${MERGED_AT}" ]; then
              echo "‚úÖ Draft PR merged at ${MERGED_AT}"
              break
            fi
            sleep 2
          done

          MERGED_AT=$(gh pr view "${PR_URL}" --json mergedAt --jq '.mergedAt')
          if [ "${MERGED_AT}" = "null" ] || [ -z "${MERGED_AT}" ]; then
            echo "‚ùå Draft PR merge timeout. Auto Publish dispatch skipped."
            exit 1
          fi

          if [ -n "${DRAFT_FILES_CSV}" ]; then
            echo "üöÄ Triggering Auto Publish workflow_dispatch..."
            gh workflow run auto-publish.yml --ref main -f draft_files="${DRAFT_FILES_CSV}" -f dry_run=false
            {
              echo "- Auto Publish dispatch: requested"
              echo "- Draft files: ${DRAFT_FILES_CSV}"
            } >> "$GITHUB_STEP_SUMMARY"
          else
            {
              echo "- Auto Publish dispatch: skipped (no drafts/*.md in staged diff)"
            } >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Rehearsal Skip Draft Writer
        if: github.event_name == 'workflow_dispatch' && (github.event.inputs.run_target == 'both' || github.event.inputs.run_target == 'draft') && (github.event.inputs.skip_draft_writer || 'false') == 'true'
        run: |
          echo "üß™ Rehearsal mode enabled: skip_draft_writer=true, draft generation step was intentionally skipped."
          {
            echo "- Draft writer: skipped (rehearsal mode)"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Notify on Failure (Legacy Inline)
        if: ${{ failure() && (vars.INLINE_FAILURE_NOTIFY == 'true') }}
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.GMAIL_USER }}
          password: ${{ secrets.GMAIL_APP_PASSWORD }}
          subject: "‚ùå [Content Publisher] Weekly Workflow Failed"
          to: ${{ secrets.NOTIFY_EMAIL_TO }}
          from: MandaAct Bot <${{ secrets.GMAIL_USER }}>
          body: |
            Weekly content automation workflow failed.
            
            Run ID: ${{ github.run_id }}
            Trigger: ${{ github.event_name }}
            Time: (check logs for details)
            
            üîó View Logs: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
