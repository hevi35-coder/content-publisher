name: Notify on Workflow Failure

on:
  workflow_run:
    workflows:
      - "Weekly Content Automation"
      - "Publish Smoke (Dry Run)"
      - "Auto Publish (Content Publisher)"
      - "Weekly Schedule Watchdog"
    types:
      - completed

jobs:
  notify-failure:
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
    
    steps:
      - name: Evaluate Notification Eligibility
        id: gate
        run: |
          set -euo pipefail
          CONCLUSION="${{ github.event.workflow_run.conclusion }}"
          SHOULD_NOTIFY='false'
          case "${CONCLUSION}" in
            failure|timed_out|cancelled|action_required|startup_failure)
              SHOULD_NOTIFY='true'
              ;;
          esac
          echo "conclusion=${CONCLUSION}" >> "$GITHUB_OUTPUT"
          echo "should_notify=${SHOULD_NOTIFY}" >> "$GITHUB_OUTPUT"
          if [ "${SHOULD_NOTIFY}" != "true" ]; then
            echo "ℹ️ Skipping failure notification for conclusion=${CONCLUSION}"
          fi

      - name: Checkout Code
        if: steps.gate.outputs.should_notify == 'true'
        uses: actions/checkout@v4

      - name: Setup Node.js
        if: steps.gate.outputs.should_notify == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        if: steps.gate.outputs.should_notify == 'true'
        run: npm ci

      - name: Build Failure Context
        if: steps.gate.outputs.should_notify == 'true'
        id: context
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          WF_REPOSITORY: ${{ github.repository }}
          WF_NAME: ${{ github.event.workflow_run.name }}
          WF_RUN_ID: ${{ github.event.workflow_run.id }}
          WF_RUN_URL: ${{ github.event.workflow_run.html_url }}
          WF_EVENT: ${{ github.event.workflow_run.event }}
          WF_BRANCH: ${{ github.event.workflow_run.head_branch }}
          WF_ACTOR: ${{ github.event.workflow_run.actor.login }}
        run: node scripts/build-workflow-failure-context.js

      - name: Send Failure Notification
        if: steps.gate.outputs.should_notify == 'true'
        env:
          GMAIL_USER: ${{ secrets.GMAIL_USER }}
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
          NOTIFY_EMAIL_TO: ${{ secrets.NOTIFY_EMAIL_TO }}
          WF_NAME: ${{ github.event.workflow_run.name }}
          WF_RUN_ID: ${{ github.event.workflow_run.id }}
          WF_RUN_URL: ${{ github.event.workflow_run.html_url }}
          WF_EVENT: ${{ github.event.workflow_run.event }}
          WF_BRANCH: ${{ github.event.workflow_run.head_branch }}
          WF_ACTOR: ${{ github.event.workflow_run.actor.login }}
          FAILED_JOBS: ${{ steps.context.outputs.failed_jobs }}
          ERROR_HIGHLIGHTS: ${{ steps.context.outputs.error_highlights }}
          FETCH_NOTE: ${{ steps.context.outputs.fetch_note }}
          HIGHLIGHT_NOTE: ${{ steps.context.outputs.highlight_note }}
          SMOKE_HINT: ${{ steps.context.outputs.smoke_hint }}
          ACTION_GUIDANCE: ${{ steps.context.outputs.action_guidance }}
          ERROR_MESSAGE: ${{ steps.context.outputs.error_message }}
        run: node scripts/send-workflow-failure-notification.js

      - name: Write Incident Summary
        if: always()
        env:
          SHOULD_NOTIFY: ${{ steps.gate.outputs.should_notify }}
          WF_NAME: ${{ github.event.workflow_run.name }}
          WF_CONCLUSION: ${{ github.event.workflow_run.conclusion }}
          WF_RUN_URL: ${{ github.event.workflow_run.html_url }}
          SUMMARY_FAILED_JOBS: ${{ steps.context.outputs.failed_jobs }}
          SUMMARY_ERROR_HIGHLIGHTS: ${{ steps.context.outputs.error_highlights }}
          SUMMARY_FETCH_NOTE: ${{ steps.context.outputs.fetch_note }}
          SUMMARY_HIGHLIGHT_NOTE: ${{ steps.context.outputs.highlight_note }}
          SUMMARY_ACTION_GUIDANCE: ${{ steps.context.outputs.action_guidance }}
          SUMMARY_SMOKE_HINT: ${{ steps.context.outputs.smoke_hint }}
        run: node scripts/write-workflow-incident-summary.js
