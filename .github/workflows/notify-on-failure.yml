name: Notify on Workflow Failure

on:
  workflow_run:
    workflows:
      - "Weekly Content Automation"
      - "Publish Smoke (Dry Run)"
      - "Auto Publish (Content Publisher)"
    types:
      - completed

jobs:
  notify-failure:
    runs-on: ubuntu-latest
    if: ${{ contains(fromJson('["failure","timed_out","cancelled","action_required","startup_failure"]'), github.event.workflow_run.conclusion) }}
    permissions:
      actions: read
      contents: read
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: npm ci

      - name: Build Failure Context
        id: context
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          WF_REPOSITORY: ${{ github.repository }}
          WF_NAME: ${{ github.event.workflow_run.name }}
          WF_RUN_ID: ${{ github.event.workflow_run.id }}
          WF_RUN_URL: ${{ github.event.workflow_run.html_url }}
          WF_EVENT: ${{ github.event.workflow_run.event }}
          WF_BRANCH: ${{ github.event.workflow_run.head_branch }}
          WF_ACTOR: ${{ github.event.workflow_run.actor.login }}
        run: node scripts/build-workflow-failure-context.js

      - name: Send Failure Notification
        env:
          GMAIL_USER: ${{ secrets.GMAIL_USER }}
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
          NOTIFY_EMAIL_TO: ${{ secrets.NOTIFY_EMAIL_TO }}
          WF_NAME: ${{ github.event.workflow_run.name }}
          WF_RUN_ID: ${{ github.event.workflow_run.id }}
          WF_RUN_URL: ${{ github.event.workflow_run.html_url }}
          WF_EVENT: ${{ github.event.workflow_run.event }}
          WF_BRANCH: ${{ github.event.workflow_run.head_branch }}
          WF_ACTOR: ${{ github.event.workflow_run.actor.login }}
          FAILED_JOBS: ${{ steps.context.outputs.failed_jobs }}
          ERROR_HIGHLIGHTS: ${{ steps.context.outputs.error_highlights }}
          FETCH_NOTE: ${{ steps.context.outputs.fetch_note }}
          HIGHLIGHT_NOTE: ${{ steps.context.outputs.highlight_note }}
          SMOKE_HINT: ${{ steps.context.outputs.smoke_hint }}
          ACTION_GUIDANCE: ${{ steps.context.outputs.action_guidance }}
          ERROR_MESSAGE: ${{ steps.context.outputs.error_message }}
        run: node scripts/send-workflow-failure-notification.js

      - name: Write Incident Summary
        if: always()
        run: |
          {
            echo "# Workflow Incident Summary"
            echo
            echo "- Workflow: ${{ github.event.workflow_run.name }}"
            echo "- Conclusion: ${{ github.event.workflow_run.conclusion }}"
            echo "- Run URL: ${{ github.event.workflow_run.html_url }}"
            echo
            echo "## Failed Jobs"
            printf '%s\n' "${{ steps.context.outputs.failed_jobs }}"
            echo
            echo "## Error Highlights"
            printf '%s\n' "${{ steps.context.outputs.error_highlights }}"
            if [ -n "${{ steps.context.outputs.fetch_note }}" ]; then
              echo
              echo "## Fetch Note"
              printf '%s\n' "${{ steps.context.outputs.fetch_note }}"
            fi
            if [ -n "${{ steps.context.outputs.highlight_note }}" ]; then
              echo
              echo "## Highlight Note"
              printf '%s\n' "${{ steps.context.outputs.highlight_note }}"
            fi
            if [ -n "${{ steps.context.outputs.action_guidance }}" ]; then
              echo
              echo "## Action Guidance"
              printf '%s\n' "${{ steps.context.outputs.action_guidance }}"
            fi
            if [ -n "${{ steps.context.outputs.smoke_hint }}" ]; then
              echo
              echo "## Smoke Hint"
              printf '%s\n' "${{ steps.context.outputs.smoke_hint }}"
            fi
          } >> "$GITHUB_STEP_SUMMARY"
