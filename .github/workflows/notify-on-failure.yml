name: Notify on Workflow Failure

on:
  workflow_run:
    workflows:
      - "Weekly Content Automation"
      - "Auto Publish (Content Publisher)"
      - "Weekly Schedule Watchdog"
    types:
      - completed

jobs:
  notify-failure:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' && github.event.workflow_run.head_branch == 'main' }}
    permissions:
      actions: read
      contents: read
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: npm ci

      - name: Diagnose Failure Root Cause
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          WORKFLOW_RUN_ID: ${{ github.event.workflow_run.id }}
          WORKFLOW_NAME: ${{ github.event.workflow_run.name }}
          WORKFLOW_RUN_URL: ${{ github.event.workflow_run.html_url }}
          WORKFLOW_EVENT_NAME: ${{ github.event.workflow_run.event }}
          WORKFLOW_HEAD_BRANCH: ${{ github.event.workflow_run.head_branch }}
        run: node scripts/diagnose-workflow-failure.js

      - name: Upload Failure Diagnosis Artifact
        uses: actions/upload-artifact@v4
        with:
          name: failure-diagnosis-${{ github.event.workflow_run.id }}
          path: |
            output/failure-diagnosis.json
            output/failure-diagnosis.md
          if-no-files-found: warn

      - name: Send Failure Notification
        env:
          GMAIL_USER: ${{ secrets.GMAIL_USER }}
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
          NOTIFY_EMAIL_TO: ${{ secrets.NOTIFY_EMAIL_TO }}
          WORKFLOW_NAME: ${{ github.event.workflow_run.name }}
          WORKFLOW_RUN_URL: ${{ github.event.workflow_run.html_url }}
          WORKFLOW_EVENT_NAME: ${{ github.event.workflow_run.event }}
          WORKFLOW_HEAD_BRANCH: ${{ github.event.workflow_run.head_branch }}
        run: node scripts/send-failure-notification.js
