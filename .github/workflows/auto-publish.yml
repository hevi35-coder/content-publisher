name: Auto Publish (Content Publisher)

on:
  push:
    branches:
      - main
    paths:
      - 'drafts/**'
  workflow_dispatch:
    inputs:
      draft_files:
        description: "Draft files to publish (comma or newline separated)"
        required: false
        type: string
      dry_run:
        description: "Simulation mode (true: no real publish)"
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

concurrency:
  group: auto-publish-${{ github.ref }}
  cancel-in-progress: false

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Needed to diff full push range reliably

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: npm ci

      - name: Resolve Target Draft Files
        id: files
        env:
          EVENT_NAME: ${{ github.event_name }}
          BEFORE_SHA: ${{ github.event.before }}
          CURRENT_SHA: ${{ github.sha }}
          INPUT_DRAFT_FILES: ${{ github.event.inputs.draft_files || '' }}
        run: |
          node scripts/resolve-draft-files.js

      - name: Publish Mode Summary
        if: steps.files.outputs.has_files == 'true'
        env:
          DRY_RUN: ${{ github.event_name == 'workflow_dispatch' && (github.event.inputs.dry_run || 'true') || (vars.DRY_RUN || 'false') }}
          FORCE_PUBLISH: ${{ vars.FORCE_PUBLISH || 'true' }}
          VERIFY_PUBLISHED_URLS: ${{ vars.VERIFY_PUBLISHED_URLS || 'true' }}
        run: |
          set -euo pipefail
          echo "Target source: ${{ steps.files.outputs.source }}"
          echo "Target files: ${{ steps.files.outputs.file_count }}"
          echo "Resolved DRY_RUN: ${DRY_RUN}"
          echo "Resolved FORCE_PUBLISH: ${FORCE_PUBLISH}"
          echo "Resolved VERIFY_PUBLISHED_URLS: ${VERIFY_PUBLISHED_URLS}"
          if [ "${DRY_RUN}" = "true" ]; then
            echo "::warning::DRY_RUN=true. External platforms will not receive real posts."
          fi
          {
            echo "# Auto Publish Summary"
            echo
            echo "- Source: ${{ steps.files.outputs.source }}"
            echo "- Target files: ${{ steps.files.outputs.file_count }}"
            echo "- DRY_RUN: ${DRY_RUN}"
            echo "- FORCE_PUBLISH: ${FORCE_PUBLISH}"
            echo "- VERIFY_PUBLISHED_URLS: ${VERIFY_PUBLISHED_URLS}"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Manual Run Missing Draft Files
        if: github.event_name == 'workflow_dispatch' && steps.files.outputs.has_files != 'true'
        run: |
          echo "::error::No draft files resolved for manual run. Provide workflow_dispatch input: draft_files."
          exit 1

      - name: No Drafts to Publish (Push Event)
        if: github.event_name != 'workflow_dispatch' && steps.files.outputs.has_files != 'true'
        run: echo "No changed draft files detected on push. Skipping publish."

      - name: Preflight Secret Validation
        if: steps.files.outputs.has_files == 'true'
        env:
          DRY_RUN: ${{ github.event_name == 'workflow_dispatch' && (github.event.inputs.dry_run || 'true') || (vars.DRY_RUN || 'false') }}
          FORCE_PUBLISH: ${{ vars.FORCE_PUBLISH || 'true' }}
          MIN_DRAFT_BODY_CHARS: ${{ vars.MIN_DRAFT_BODY_CHARS || '120' }}
          TARGET_FILES: ${{ steps.files.outputs.files }}
          DEVTO_API_KEY: ${{ secrets.DEVTO_API_KEY }}
          HASHNODE_PAT: ${{ secrets.HASHNODE_PAT }}
          HASHNODE_PUBLICATION_ID: ${{ secrets.HASHNODE_PUBLICATION_ID }}
          BLOGGER_BLOG_ID: ${{ secrets.BLOGGER_BLOG_ID }}
          BLOGGER_CLIENT_ID: ${{ secrets.BLOGGER_CLIENT_ID }}
          BLOGGER_CLIENT_SECRET: ${{ secrets.BLOGGER_CLIENT_SECRET }}
          BLOGGER_REFRESH_TOKEN: ${{ secrets.BLOGGER_REFRESH_TOKEN }}
          BLOGGER_ACCESS_TOKEN: ${{ secrets.BLOGGER_ACCESS_TOKEN }}
        run: |
          node scripts/check-publish-secrets.js
          {
            echo "- Preflight: passed"
            echo "- MIN_DRAFT_BODY_CHARS: ${MIN_DRAFT_BODY_CHARS}"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Run Publisher
        if: steps.files.outputs.has_files == 'true'
        env:
          DRY_RUN: ${{ github.event_name == 'workflow_dispatch' && (github.event.inputs.dry_run || 'true') || (vars.DRY_RUN || 'false') }}
          FORCE_PUBLISH: ${{ vars.FORCE_PUBLISH || 'true' }}
          VERIFY_PUBLISHED_URLS: ${{ vars.VERIFY_PUBLISHED_URLS || 'true' }}
          DEVTO_API_KEY: ${{ secrets.DEVTO_API_KEY }}
          HASHNODE_PAT: ${{ secrets.HASHNODE_PAT }}
          HASHNODE_PUBLICATION_ID: ${{ secrets.HASHNODE_PUBLICATION_ID }}
          BLOGGER_BLOG_ID: ${{ secrets.BLOGGER_BLOG_ID }}
          BLOGGER_CLIENT_ID: ${{ secrets.BLOGGER_CLIENT_ID }}
          BLOGGER_CLIENT_SECRET: ${{ secrets.BLOGGER_CLIENT_SECRET }}
          BLOGGER_REFRESH_TOKEN: ${{ secrets.BLOGGER_REFRESH_TOKEN }}
          BLOGGER_ACCESS_TOKEN: ${{ secrets.BLOGGER_ACCESS_TOKEN }}
        run: |
          set -euo pipefail

          while IFS= read -r file; do
            [ -z "$file" ] && continue
            if [ ! -f "$file" ]; then
              echo "::error::Draft file not found: $file"
              exit 1
            fi
            echo "üöÄ Publishing $file..."
            node publish.js "$file"
          done <<< "${{ steps.files.outputs.files }}"

      - name: Post-publish Hashnode Duplicate Cleanup
        id: hashnode_dedupe
        if: steps.files.outputs.has_files == 'true'
        continue-on-error: true
        env:
          DRY_RUN: ${{ github.event_name == 'workflow_dispatch' && (github.event.inputs.dry_run || 'true') || (vars.DRY_RUN || 'false') }}
          TARGET_FILES: ${{ steps.files.outputs.files }}
          HASHNODE_AUTO_DEDUPE: ${{ vars.HASHNODE_AUTO_DEDUPE || 'true' }}
          HASHNODE_DEDUPE_MAX_SCAN: ${{ vars.HASHNODE_DEDUPE_MAX_SCAN || '240' }}
          HASHNODE_DEDUPE_MAX_AGE_HOURS: ${{ vars.HASHNODE_DEDUPE_MAX_AGE_HOURS || '12' }}
          HASHNODE_PAT: ${{ secrets.HASHNODE_PAT }}
          HASHNODE_PUBLICATION_ID: ${{ secrets.HASHNODE_PUBLICATION_ID }}
        run: |
          node scripts/hashnode-post-publish-dedupe.js

      - name: Enforce Dedupe Failure Policy
        if: steps.files.outputs.has_files == 'true' && steps.hashnode_dedupe.outcome == 'failure'
        env:
          HASHNODE_AUTO_DEDUPE_STRICT: ${{ vars.HASHNODE_AUTO_DEDUPE_STRICT || 'false' }}
        run: |
          if [ "${HASHNODE_AUTO_DEDUPE_STRICT}" = "true" ]; then
            echo "::error::Hashnode dedupe failed and strict mode is enabled (HASHNODE_AUTO_DEDUPE_STRICT=true)."
            exit 1
          fi

          echo "::warning::Hashnode dedupe failed, but strict mode is disabled. Continuing pipeline."
          {
            echo "- Hashnode dedupe: failed (non-blocking)"
            echo "- Strict mode: ${HASHNODE_AUTO_DEDUPE_STRICT}"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Notify on Failure (Legacy Inline)
        if: ${{ failure() && (vars.INLINE_FAILURE_NOTIFY == 'true') }}
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.GMAIL_USER }}
          password: ${{ secrets.GMAIL_APP_PASSWORD }}
          subject: "‚ùå [Content Publisher] Auto Publish Failed"
          to: ${{ secrets.NOTIFY_EMAIL_TO }}
          from: MandaAct Bot <${{ secrets.GMAIL_USER }}>
          body: |
            Auto publish workflow failed.
            
            Run ID: ${{ github.run_id }}
            Trigger: ${{ github.event_name }}
            
            üîó View Logs: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
