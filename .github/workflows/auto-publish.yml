name: Auto Publish (Content Publisher)

on:
  push:
    branches:
      - main
    paths:
      - 'drafts/**'
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Run publisher in dry-run mode (no external API writes)"
        required: true
        default: 'true'
        type: choice
        options:
          - 'false'
          - 'true'
      draft_files:
        description: "Optional newline/comma-separated drafts/*.md list for manual backfill"
        required: false
        default: ''
        type: string

concurrency:
  group: auto-publish-${{ github.ref }}
  cancel-in-progress: false

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Needed to diff full push range reliably

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: npm ci

      - name: Identify Changed Draft Files
        id: files
        env:
          MANUAL_FILES_RAW: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.draft_files || '' }}
        run: |
          set -euo pipefail

          MANUAL_FILES=$(printf "%s\n" "$MANUAL_FILES_RAW" \
            | tr ',\r' '\n' \
            | sed 's/^ *//;s/ *$//' \
            | grep '^drafts/.*\.md$' || true)

          # Fail fast when manual override is provided but malformed.
          MANUAL_FILES_RAW_STRIPPED=$(printf "%s" "$MANUAL_FILES_RAW" | tr -d '[:space:],')
          if [ -n "$MANUAL_FILES_RAW_STRIPPED" ] && [ -z "$MANUAL_FILES" ]; then
            echo "::error::workflow_dispatch draft_files was provided but no valid drafts/*.md entries were found."
            exit 1
          fi

          if [ -n "$MANUAL_FILES" ]; then
            echo "Using workflow_dispatch draft_files override:"
            echo "$MANUAL_FILES"
            {
              echo "has_files=true"
              echo "files<<EOF"
              echo "$MANUAL_FILES"
              echo "EOF"
            } >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Get all changed markdown files under drafts/ for push range.
          # Fallback for manual dispatch: latest commit changes.
          if [ "${{ github.event_name }}" = "push" ] && [ "${{ github.event.before }}" != "0000000000000000000000000000000000000000" ]; then
            BASE_SHA="${{ github.event.before }}"
            HEAD_SHA="${{ github.sha }}"
            if git cat-file -e "$BASE_SHA^{commit}" 2>/dev/null; then
              CHANGED_FILES=$(git diff --name-only "$BASE_SHA" "$HEAD_SHA" | grep '^drafts/.*\.md$' || true)
            else
              CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD | grep '^drafts/.*\.md$' || true)
            fi
          elif git rev-parse --verify HEAD~1 >/dev/null 2>&1; then
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD | grep '^drafts/.*\.md$' || true)
          else
            CHANGED_FILES=$(git show --pretty="" --name-only HEAD | grep '^drafts/.*\.md$' || true)
          fi

          if [ -z "$CHANGED_FILES" ]; then
            echo "No draft files changed."
            if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
              echo "::error::No publish target resolved. Provide workflow_dispatch draft_files (drafts/*.md), or trigger via main push with changed drafts."
              exit 1
            fi
            echo "has_files=false" >> "$GITHUB_OUTPUT"
          else
            echo "Found changed drafts:"
            echo "$CHANGED_FILES"
            {
              echo "has_files=true"
              echo "files<<EOF"
              echo "$CHANGED_FILES"
              echo "EOF"
            } >> "$GITHUB_OUTPUT"
          fi

      - name: Run Publisher
        if: steps.files.outputs.has_files == 'true'
        env:
          DEVTO_API_KEY: ${{ secrets.DEVTO_API_KEY }}
          HASHNODE_PAT: ${{ secrets.HASHNODE_PAT }}
          HASHNODE_PUBLICATION_ID: ${{ secrets.HASHNODE_PUBLICATION_ID }}
          BLOGGER_BLOG_ID: ${{ secrets.BLOGGER_BLOG_ID }}
          BLOGGER_CLIENT_ID: ${{ secrets.BLOGGER_CLIENT_ID }}
          BLOGGER_CLIENT_SECRET: ${{ secrets.BLOGGER_CLIENT_SECRET }}
          BLOGGER_REFRESH_TOKEN: ${{ secrets.BLOGGER_REFRESH_TOKEN }}
          BLOGGER_ACCESS_TOKEN: ${{ secrets.BLOGGER_ACCESS_TOKEN }}
          DRY_RUN: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.dry_run || 'false' }}
        run: |
          set -euo pipefail
          echo "DRY_RUN=${DRY_RUN}"

          while IFS= read -r file; do
            [ -z "$file" ] && continue
            if [ ! -f "$file" ]; then
              echo "‚è≠Ô∏è Skipping missing draft (deleted or renamed): $file"
              continue
            fi
            echo "üöÄ Publishing $file..."
            node publish.js "$file"
          done <<< "${{ steps.files.outputs.files }}"

      - name: Notify on Failure
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.GMAIL_USER }}
          password: ${{ secrets.GMAIL_APP_PASSWORD }}
          subject: "‚ùå [Content Publisher] Auto Publish Failed"
          to: ${{ secrets.NOTIFY_EMAIL_TO }}
          from: MandaAct Bot <${{ secrets.GMAIL_USER }}>
          body: |
            Auto publish workflow failed.
            
            Run ID: ${{ github.run_id }}
            Trigger: ${{ github.event_name }}
            
            üîó View Logs: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
