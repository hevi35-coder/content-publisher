name: Weekly Schedule Watchdog

on:
  schedule:
    # Run after expected 16:07 KST schedule (grace included)
    # Sunday 19:37 KST (Sunday 10:37 UTC)
    - cron: '37 10 * * 0'
    # Tuesday/Thursday/Saturday 19:37 KST (Tuesday/Thursday/Saturday 10:37 UTC)
    - cron: '37 10 * * 2,4,6'
  workflow_dispatch:
    inputs:
      simulate_missed:
        description: "Rehearsal: simulate missed slot and test fallback dispatch path"
        required: true
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

jobs:
  watchdog:
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read
    env:
      TZ: Asia/Seoul
      WEEKLY_WORKFLOW_REF: '.github/workflows/weekly-content.yml'
      SCHEDULE_WATCHDOG_GRACE_MINUTES: '180'
      SCHEDULE_WATCHDOG_EARLY_ALLOWANCE_MINUTES: '15'
      SCHEDULE_WATCHDOG_API_MAX_ATTEMPTS: '3'
      SCHEDULE_WATCHDOG_API_RETRY_BASE_MS: '2000'
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: npm ci

      - name: Check Weekly Schedule Run Health
        id: watchdog
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: node scripts/check-weekly-schedule-watchdog.js

      - name: Trigger Draft Fallback Run (On Missed Schedule)
        if: |
          (steps.watchdog.outputs.watchdog_status == 'MISSED' && github.event_name == 'schedule' && github.run_attempt == 1) ||
          (github.event_name == 'workflow_dispatch' && (github.event.inputs.simulate_missed || 'false') == 'true')
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ github.event.inputs.simulate_missed || 'false' }}" = "true" ]; then
            echo "Watchdog rehearsal mode: simulating MISSED slot and triggering DRY_RUN fallback dispatch."
            gh workflow run "Weekly Content Automation" \
              --ref main \
              -f run_target=draft \
              -f dry_run=true \
              -f manual_fallback_force=true \
              -f skip_draft_writer=true
          else
            echo "Watchdog detected missed schedule slot (${{ steps.watchdog.outputs.due_slot_utc }}). Triggering Weekly Content Automation fallback run (run_target=draft)."
            gh workflow run "Weekly Content Automation" \
              --ref main \
              -f run_target=draft \
              -f dry_run=false \
              -f manual_fallback_force=false
          fi

      - name: Write Watchdog Summary
        if: always()
        run: |
          {
            echo "## Weekly Schedule Watchdog"
            echo
            echo "- Status: ${{ steps.watchdog.outputs.watchdog_status || 'UNKNOWN' }}"
            echo "- Due slot (UTC): ${{ steps.watchdog.outputs.due_slot_utc || 'n/a' }}"
            echo "- Matched run (UTC): ${{ steps.watchdog.outputs.matched_run_at_utc || 'n/a' }}"
            echo "- Rehearsal mode: ${{ github.event_name == 'workflow_dispatch' && (github.event.inputs.simulate_missed || 'false') == 'true' }}"
            echo "- Fallback dispatch attempted: ${{ (steps.watchdog.outputs.watchdog_status == 'MISSED' && github.event_name == 'schedule' && github.run_attempt == 1) || (github.event_name == 'workflow_dispatch' && (github.event.inputs.simulate_missed || 'false') == 'true') }}"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Fail on Missed Slot (Alert Surface)
        if: steps.watchdog.outputs.watchdog_status == 'MISSED' && github.event_name == 'schedule'
        run: |
          echo "::error::SCHEDULE_SLOT_MISSED Watchdog triggered fallback dispatch and is failing intentionally for visibility."
          exit 1

      - name: Fail on Watchdog Runtime Error
        if: steps.watchdog.outcome == 'failure' && steps.watchdog.outputs.watchdog_status != 'MISSED'
        run: |
          echo "::error::WATCHDOG_RUNTIME_ERROR Weekly schedule watchdog script failed unexpectedly."
          exit 1
